<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Happy 23 ðŸŽ‚</title>
  <style>
    :root{
      --bg:#e9fcff;
      --plate1:#8f5be7;
      --plate2:#6d49cf;
      --cake:#ffe07a;
      --cap:#ef7171;
    }
    html,body{margin:0;padding:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#202020}
    .wrap{max-width:980px;margin:28px auto;padding:16px;display:flex;flex-direction:column;gap:18px;align-items:center}
    h1{margin:4px 0 0;font-size:clamp(24px,3.2vw,36px);text-align:center}
    .lead{opacity:.8;margin:0;text-align:center}

    /* Minimal control bar: only relight */
    .topbar{display:flex;justify-content:center;margin:8px 0 0}
    button{border:none;background:#111;color:#fff;border-radius:12px;padding:10px 14px;box-shadow:0 6px 16px rgba(0,0,0,.12);font-weight:700;cursor:pointer}
    button.secondary{background:#f3f3f3;color:#111}

    .stage{width:min(900px,95vw);display:grid;place-items:center}
    svg{width:100%;height:auto;display:block;}

    .msg{display:none;font-weight:800}
    .msg.show{display:block}

    .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
    .piece{position:absolute;top:-10%;width:10px;height:14px;opacity:.9;animation:fall 2.4s ease-in forwards}
    @keyframes fall{to{transform:translateY(120vh) rotate(540deg);opacity:1}}

    /* Tap-to-start overlay (required for iOS/Chrome autoplay policies) */
    .gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(233,252,255,.85);backdrop-filter:saturate(1.2) blur(2px);z-index:50}
    .card{background:#fff;border-radius:16px;padding:16px 18px;box-shadow:0 10px 30px rgba(0,0,0,.12);text-align:center;max-width:520px}
    .card h2{margin:0 0 6px;font-size:18px}
    .card p{margin:0 0 12px;opacity:.85}
    .gate .tap{display:inline-block;border-radius:999px;padding:10px 14px;background:#111;color:#fff;font-weight:700}
    .gate .tip{margin-top:8px;font-size:12px;opacity:.7}
    .hide{display:none}
    .error{color:#c9342f;font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Happy 23rd Birthday ðŸŽ‰</h1>
    <p class="lead">Candles sit behind the top cap. Plate is flush and in front. (Mic starts after a quick tap.)</p>

    <div class="topbar"><button id="resetBtn" class="secondary">Relight Candles</button></div>

    <div class="stage">
      <svg id="cakeSvg" viewBox="0 0 900 560" aria-label="Birthday cake with 23 candles clipped above cap and front plate">
        <defs>
          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="160%">
            <feDropShadow dx="0" dy="8" stdDeviation="8" flood-opacity=".16"/>
          </filter>
          <radialGradient id="flameGrad" cx="50%" cy="60%" r="60%">
            <stop offset="0%" stop-color="#fff7c2"/>
            <stop offset="55%" stop-color="#ffd35a"/>
            <stop offset="85%" stop-color="#ff9f1a"/>
            <stop offset="100%" stop-color="rgba(255,159,26,0)"/>
          </radialGradient>
          <linearGradient id="plateGrad" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="var(--plate1)"/>
            <stop offset="100%" stop-color="var(--plate2)"/>
          </linearGradient>
          <!-- clip that reveals only parts ABOVE a dynamic y set in JS -->
          <clipPath id="wickClip">
            <rect id="wickClipRect" x="0" y="0" width="900" height="150"></rect>
          </clipPath>
        </defs>

        <!-- BACK: Top tier body only -->
        <g id="tierTopBody" filter="url(#softShadow)">
          <rect id="topRect" x="310" y="170" width="300" height="90" rx="20" fill="var(--cake)" />
          <!-- surface guide -->
          <rect id="topSurface" x="320" y="168" width="280" height="4" fill="transparent"/>
        </g>

        <!-- Candles apply clip so only wicks+flames above cap's top are visible -->
        <g id="candleLayer" clip-path="url(#wickClip)"></g>

        <!-- Top cap IN FRONT of candles -->
        <g id="topCap" filter="url(#softShadow)">
          <rect id="capRect" x="310" y="152" width="300" height="30" rx="15" fill="var(--cap)" />
        </g>

        <!-- Middle tier -->
        <g id="tierMid" filter="url(#softShadow)">
          <rect x="210" y="240" width="480" height="110" rx="24" fill="var(--cake)" />
          <rect x="210" y="218" width="480" height="32" rx="16" fill="var(--cap)" />
        </g>

        <!-- Bottom tier -->
        <g id="tierBottom" filter="url(#softShadow)">
          <rect x="120" y="320" width="660" height="140" rx="28" fill="var(--cake)" />
          <rect x="120" y="296" width="660" height="36" rx="18" fill="var(--cap)" />
        </g>

        <!-- Plate LAST (front-most) and FLUSH at y=460 -->
        <g id="plate" transform="translate(90,460)">
          <rect x="0" y="0" rx="22" ry="22" width="720" height="40" fill="url(#plateGrad)" filter="url(#softShadow)"/>
          <ellipse cx="360" cy="48" rx="300" ry="12" fill="rgba(0,0,0,.10)"/>
        </g>
      </svg>
    </div>

    <div class="msg" id="msg">All candles out â€” make a wish! âœ¨</div>
  </div>

  <!-- Mic permission gate -->
  <div id="gate" class="gate">
    <div class="card">
      <h2>Tap to blow out the candles</h2>
      <p>This quick tap turns on your microphone (required by your browser).</p>
      <div class="tap" id="tapStart" role="button" tabindex="0">Tap to enable mic</div>
      <div id="gateErr" class="tip"></div>
    </div>
  </div>

  <div class="confetti" id="confetti"></div>

<script>
(() => {
  const N = 23;
  const candleLayer = document.getElementById('candleLayer');
  const topSurface = document.getElementById('topSurface');
  const capRect = document.getElementById('capRect');
  const wickClipRect = document.getElementById('wickClipRect');
  const resetBtn = document.getElementById('resetBtn');
  const msg = document.getElementById('msg');
  const confetti = document.getElementById('confetti');

  const gate = document.getElementById('gate');
  const tapStart = document.getElementById('tapStart');
  const gateErr = document.getElementById('gateErr');

  let audioStream = null, ctx = null, analyser = null, data = null;
  let raf = 0;
  let candlesOn = new Array(N).fill(true);

  // Fixed mid sensitivity (same as slider value 60/1000)
  const THRESHOLD = 0.06;

  // Personalize via URL params
  const params = new URLSearchParams(location.search);
  const who = params.get('name');
  const age = parseInt(params.get('age') || '23', 10);
  if (!Number.isNaN(age) && age !== 23) {
    document.title = `Happy ${age}`;
    document.querySelector('h1').textContent = `Happy ${age}th Birthday ðŸŽ‰`;
  }
  if (who) document.querySelector('h1').textContent += `, ${who}`;

  // SVG helper
  const svgEl = (name, attrs={}) => {
    const el = document.createElementNS('http://www.w3.org/2000/svg', name);
    for (const [k,v] of Object.entries(attrs)) el.setAttribute(k,v);
    return el;
  };

  function updateWickClip() {
    // Show only wicks+flames above the cap's top edge
    const capY = parseFloat(capRect.getAttribute('y'));
    wickClipRect.setAttribute('y', 0);
    wickClipRect.setAttribute('height', capY);
  }

  function placeCandles() {
    updateWickClip();
    candlesOn = new Array(N).fill(true);
    while (candleLayer.firstChild) candleLayer.removeChild(candleLayer.firstChild);

    const x = parseFloat(topSurface.getAttribute('x'));
    const y = parseFloat(topSurface.getAttribute('y'));
    const w = parseFloat(topSurface.getAttribute('width'));
    const margin = 8;
    const usable = w - margin*2;
    const step = usable / (N-1);
    const baseY = y;

    for (let i=0;i<N;i++) {
      const cx = x + margin + i*step;
      const g = svgEl('g', { class:'candle', 'data-idx': i });
      const h = 44;
      g.appendChild(svgEl('rect',{x: cx - 5, y: baseY - h, width: 10, height: h, rx: 3, fill:'#ffffff'}));
      g.appendChild(svgEl('rect',{x: cx-1, y: baseY - h - 8, width:2, height:8, fill:'#5a3d2b', rx:1}));
      g.appendChild(svgEl('ellipse',{cx: cx, cy: baseY - h - 18, rx: 6.5, ry: 10.5, fill:'url(#flameGrad)'}));
      candleLayer.appendChild(g);
    }
    msg.classList.remove('show');
  }

  placeCandles();
  addEventListener('resize', updateWickClip);

  function setCandleState(idx, on) {
    const g = candleLayer.querySelector(`g[data-idx="${idx}"]`);
    if (!g) return;
    const flame = g.querySelector('ellipse');
    flame.style.opacity = on ? 1 : 0;
    candlesOn[idx] = on;
  }

  function relightAll() {
    for (let i=0;i<N;i++) setCandleState(i, true);
    confetti.innerHTML = '';
    msg.classList.remove('show');
  }

  function finish() { msg.classList.add('show'); burstConfetti(); }
  resetBtn.addEventListener('click', relightAll);

  function burstConfetti() {
    confetti.innerHTML = '';
    const colors = ['#ff7676','#fbd14b','#7cdedc','#7bd88a','#8e7dff'];
    const pieces = 100;
    for (let i=0;i<pieces;i++) {
      const p = document.createElement('div');
      p.className = 'piece';
      p.style.left = Math.random()*100 + '%';
      p.style.background = colors[i % colors.length];
      p.style.transform = `rotate(${Math.random()*360}deg)`;
      p.style.animationDelay = (Math.random()*0.6)+'s';
      confetti.appendChild(p);
    }
  }

  function rmsFromData(arr) {
    let sum=0; for (let i=0;i<arr.length;i++){ const v=(arr[i]-128)/128; sum+=v*v; } return Math.sqrt(sum/arr.length);
  }

  let blowOnSince = 0;

  function extinguishSome(count) {
    let left = [];
    for (let i=0;i<N;i++) if (candlesOn[i]) left.push(i);
    for (let k=0;k<count && left.length;k++) {
      const j = Math.floor(Math.random()*left.length);
      const idx = left.splice(j,1)[0];
      setCandleState(idx, false);
    }
    if (candlesOn.every(v=>!v)) finish();
  }

  function loop() {
    if (!analyser) return;
    analyser.getByteTimeDomainData(data);
    const rms = rmsFromData(data);

    const now = performance.now();
    if (rms > THRESHOLD) {
      if (!blowOnSince) blowOnSince = now;
      const dur = now - blowOnSince;
      if (dur > 220) {
        const n = 1 + Math.min(6, Math.round((rms - THRESHOLD)*40 + dur/350));
        extinguishSome(n);
        blowOnSince = 0;
      }
    } else blowOnSince = 0;

    raf = requestAnimationFrame(loop);
  }

  async function startMic(){
    // Guard: must be secure context
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      gateErr.innerHTML = '<span class="error">Open over HTTPS (or localhost) for mic access.<\/span>';
      return;
    }
    try{
      // Request mic in the user gesture
      audioStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});

      // Create/resume audio context inside gesture on iOS/Safari
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      if (ctx.state === 'suspended') {
        try { await ctx.resume(); } catch(e) { /* ignore */ }
      }

      const src = ctx.createMediaStreamSource(audioStream);
      analyser = ctx.createAnalyser();
      analyser.fftSize = 2048; analyser.smoothingTimeConstant = 0.85; data = new Uint8Array(analyser.fftSize);
      src.connect(analyser);
      cancelAnimationFrame(raf); raf = requestAnimationFrame(loop);
      gate.classList.add('hide');
    } catch(err){
      console.error(err);
      // Helpful guidance depending on error
      let m = 'Need microphone access to blow out candles.';
      if (err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')) {
        m = 'Microphone permission was blocked. Enable mic for this site in your browser settings, then tap Retry.';
      } else if (err && err.name === 'NotFoundError') {
        m = 'No microphone was found on this device.';
      }
      gateErr.innerHTML = '<span class="error">' + m + '<\/span>';
    }
  }

  // Explicit user gesture only (overlay acts as the gesture)
  function handleTap(){ startMic(); }
  tapStart.addEventListener('click', handleTap);
  tapStart.addEventListener('pointerdown', handleTap);
  tapStart.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') handleTap(); });
})();
</script>
</body>
</html>
