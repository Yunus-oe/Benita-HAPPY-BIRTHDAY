<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alles Gute zum 23 ğŸ‚</title>
  <style>
    :root{
      --bg:#e9fcff;
      --cake:#ffe07a;
      --cap:#ef7171;
      --plate1:#8f5be7;
      --plate2:#6d49cf;
      --ink:#111;
    }
    html,body{margin:0;padding:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
    .wrap{max-width:980px;margin:28px auto;padding:16px;display:flex;flex-direction:column;gap:18px;align-items:center}
    h1{margin:4px 0 0;font-size:clamp(24px,3.2vw,36px);text-align:center}
    .topbar{display:flex;justify-content:center;margin:4px 0 0}
    button{border:none;background:#111;color:#fff;border-radius:12px;padding:10px 14px;box-shadow:0 6px 16px rgba(0,0,0,.12);font-weight:700;cursor:pointer}
    button.secondary{background:#f3f3f3;color:#111}

    /* SpaÃŸâ€‘Mikro-Button */
    .fun{background:linear-gradient(135deg,#ff7eb3,#ff758c);color:#fff;border:none;position:relative}
    .fun:after{content:'ğŸ’¨';position:absolute;right:-12px;top:-8px;font-size:18px;animation:float 2.2s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
    .fun.on{background:#2ecc71}
    .topbar{gap:8px;flex-wrap:wrap}

    .stage{width:min(900px,95vw);display:grid;place-items:center}
    svg{width:100%;height:auto;display:block}

    /* Success/message overlay appears only after all candles are out */
    .msg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(233,252,255,.72);z-index:70}
    .msg.show{display:flex}
    .msg .card{background:var(--cap);color:#fff;border-radius:18px;padding:18px 20px;max-width:min(620px,90vw);text-align:center;box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .msg .card p{margin:8px 0}

    /* Rechts schwebender ZurÃ¼ck-Button */
    .back{position:fixed;right:12px;top:50%;transform:translateY(-50%);display:none;align-items:center;gap:6px;background:#111;color:#fff;border-radius:999px;padding:10px 14px;box-shadow:0 6px 16px rgba(0,0,0,.12);z-index:80}
    .back.show{display:flex}

    .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
    .piece{position:absolute;top:-10%;width:10px;height:14px;opacity:.9;animation:fall 2.4s ease-in forwards}
    @keyframes fall{to{transform:translateY(120vh) rotate(540deg);opacity:1}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Alles Gute zum 23. Geburtstag ğŸ‰</h1>
    <div class="topbar"><button id="micBtn" class="fun" title="Tippen & pusten!">ğŸ¤ Mikro an â€“ pusten!</button></div>

    <div class="stage">
      <svg id="cakeSvg" viewBox="0 0 900 560" aria-label="Birthday cake with 23 candles">
        <defs>
          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="160%">
            <feDropShadow dx="0" dy="8" stdDeviation="8" flood-opacity=".16"/>
          </filter>
          <radialGradient id="flameGrad" cx="50%" cy="60%" r="60%">
            <stop offset="0%" stop-color="#fff7c2"/>
            <stop offset="55%" stop-color="#ffd35a"/>
            <stop offset="85%" stop-color="#ff9f1a"/>
            <stop offset="100%" stop-color="rgba(255,159,26,0)"/>
          </radialGradient>
          <linearGradient id="plateGrad" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="var(--plate1)"/>
            <stop offset="100%" stop-color="var(--plate2)"/>
          </linearGradient>
          <!-- clip so only wicks/flames above cap show on mobiles -->
          <clipPath id="wickClip"><rect id="wickClipRect" x="0" y="0" width="900" height="150"/></clipPath>
        </defs>

        <!-- draw order: top body -> candles -> top cap -> mid -> bottom -> plate (front) -->
        <g id="tierTopBody" filter="url(#softShadow)">
          <rect id="topRect" x="310" y="170" width="300" height="90" rx="20" fill="var(--cake)"/>
          <rect id="topSurface" x="320" y="168" width="280" height="4" fill="transparent"/>
        </g>
        <g id="candleLayer" clip-path="url(#wickClip)"></g>
        <g id="topCap" filter="url(#softShadow)"><rect id="capRect" x="310" y="152" width="300" height="30" rx="15" fill="var(--cap)"/></g>
        <g id="tierMid" filter="url(#softShadow)"><rect x="210" y="240" width="480" height="110" rx="24" fill="var(--cake)"/><rect x="210" y="218" width="480" height="32" rx="16" fill="var(--cap)"/></g>
        <g id="tierBottom" filter="url(#softShadow)"><rect x="120" y="320" width="660" height="140" rx="28" fill="var(--cake)"/><rect x="120" y="296" width="660" height="36" rx="18" fill="var(--cap)"/></g>
        <g id="plate" transform="translate(90,460)"><rect x="0" y="0" rx="22" ry="22" width="720" height="40" fill="url(#plateGrad)" filter="url(#softShadow)"/><ellipse cx="360" cy="48" rx="300" ry="12" fill="rgba(0,0,0,.10)"/></g>
      </svg>
    </div>

    <div class="msg" id="msg">
      <div class="card">
        <p>â€Hayat kÄ±sa, sev, gÃ¼lÃ¼mse, mutlu ol.â€œ</p>
        <p><em>(Das Leben ist kurz â€” liebe, lÃ¤chle, sei glÃ¼cklich.)</em></p>
        <p><strong>Alles Gute zum Geburtstag, Benita ğŸ”®ğŸ‘‘ğŸ§œğŸ¼â€â™€ï¸ğŸ¥.</strong> ğŸ’›</p>
      </div>
    </div>
  </div>

  <button id="backBtn" class="back" title="ZurÃ¼ck zum Kuchen">Zum Kuchen âœ</button>

  <div class="confetti" id="confetti"></div>

<script>
(() => {
  const N = 23;
  const candleLayer = document.getElementById('candleLayer');
  const topSurface = document.getElementById('topSurface');
  const capRect = document.getElementById('capRect');
  const wickClipRect = document.getElementById('wickClipRect');  const micBtn = document.getElementById('micBtn');
  const msg = document.getElementById('msg');
  const confetti = document.getElementById('confetti');
  const backBtn = document.getElementById('backBtn');

  
  let audioStream = null, ctx = null, analyser = null, data = null, raf = 0;
  let candlesOn = new Array(N).fill(true);
  let isComplete = false;
  const THRESHOLD = 0.06; // fixed mid sensitivity

  // Personalize via ?name= & ?age=
  const params = new URLSearchParams(location.search);
  const who = params.get('name');
  const age = parseInt(params.get('age')||'23',10);
  const h1 = document.querySelector('h1');
  function setHeading(a, w){
    const ageSafe = Number.isNaN(a) ? 23 : a;
    const de = `Alles Gute zum ${ageSafe}. Geburtstag ğŸ‰` + (w ? `, ${w}` : '');
    const tr = `${ageSafe}. doÄŸum gÃ¼nÃ¼n kutlu olsun ğŸ‰`;
    const fr = `Joyeux ${ageSafe}<sup>e</sup> anniversaire ğŸ‰`;
    h1.innerHTML = `${de}<br>${tr}<br>${fr}`;
    document.title = `Alles Gute zum ${ageSafe}.`;
  }
  setHeading(age, who);
  

  // Helpers
  const svgEl = (n,a={})=>{const e=document.createElementNS('http://www.w3.org/2000/svg',n);for(const[k,v]of Object.entries(a))e.setAttribute(k,v);return e;};

  function updateWickClip(){ const capY = parseFloat(capRect.getAttribute('y')); wickClipRect.setAttribute('y',0); wickClipRect.setAttribute('height',capY); }

  function placeCandles(){
    updateWickClip();
    candlesOn = new Array(N).fill(true); while(candleLayer.firstChild) candleLayer.removeChild(candleLayer.firstChild);
    const x = +topSurface.getAttribute('x'), y = +topSurface.getAttribute('y'), w = +topSurface.getAttribute('width');
    const margin = 8, step = (w - margin*2) / (N-1), baseY = y, h=44;
    for(let i=0;i<N;i++){
      const cx = x + margin + i*step, g = svgEl('g',{'data-idx':i});
      g.appendChild(svgEl('rect',{x:cx-5,y:baseY-h,width:10,height:h,rx:3,fill:'#fff'}));
      g.appendChild(svgEl('rect',{x:cx-1,y:baseY-h-8,width:2,height:8,fill:'#5a3d2b',rx:1}));
      g.appendChild(svgEl('ellipse',{cx,cy:baseY-h-18,rx:6.5,ry:10.5,fill:'url(#flameGrad)'}));
      candleLayer.appendChild(g);
    }
    msg.classList.remove('show');
  }

  placeCandles(); addEventListener('resize', updateWickClip);

  // Sanity-Check: 23 Kerzen vorhanden?
  const _c = candleLayer.querySelectorAll('g').length; if (_c !== N) console.warn('Kerzen-Anzahl unerwartet:', _c, 'statt', N);

  function setCandleState(i,on){ const g=candleLayer.querySelector(`g[data-idx="${i}"]`); if(!g)return; g.querySelector('ellipse').style.opacity=on?1:0; candlesOn[i]=on; }
  function relightAll(){
    isComplete = false;
    blowOnSince = 0;
    for(let i=0;i<N;i++) setCandleState(i,true);
    confetti.innerHTML='';
    msg.classList.remove('show');
    backBtn.classList.remove('show');
  }  backBtn.addEventListener('click', ()=>{ msg.classList.remove('show'); backBtn.classList.remove('show'); relightAll(); });
  let winCount = 0;
  function setMessage(n){
    const card = msg.querySelector('.card');
    let html = '';
    if(n===1){
      html = `
        <p>â€Hayat kÄ±sa, sev, gÃ¼lÃ¼mse, mutlu ol.â€œ</p>
        <p><em>(Das Leben ist kurz â€” liebe, lÃ¤chle, sei glÃ¼cklich.)</em></p>
        <p><strong>Alles Gute zum Geburtstag, Benita ğŸ”®ğŸ‘‘ğŸ§œğŸ¼â€â™€ï¸ğŸ¥.</strong> ğŸ’›</p>
      `;
    } else if(n===2){
      html = `
        <p>âœ¨ Noch ein Wunsch frei!</p>
        <p>Du bekommst sogar einen <strong>zweiten Wunsch</strong> â€“ ich kannâ€™s kaum abwarten, bis du zurÃ¼ck bist. ğŸ˜„</p>
      `;
    } else if(n===10){
      html = `
        <p>ğŸ‰ 10 WÃ¼nsche... hoffe du hast einen schÃ¶nen Geburtstag, Benita &lt;3</p>
      `;
    }` : '';
      html = `
        <p>ğŸ‰ 10 WÃ¼nsche... hoffe du hast einen schÃ¶nen Geburtstag${displayName}</p>
      `;
    } else {
      html = `
        <p>ğŸ Wunsch Nr. ${n}!</p>
        <p>Du sammelst WÃ¼nsche wie Sticker â€“ weiter so. ğŸ¤­</p>
      `;
    }
    if(card) card.innerHTML = html;
  }
  function finish(){
    if (isComplete) return;
    isComplete = true;
    winCount++;
    setMessage(winCount);
    msg.classList.add('show');
    backBtn.classList.add('show');
    burstConfetti();
  }

  function burstConfetti(){ confetti.innerHTML=''; const colors=['#ff7676','#fbd14b','#7cdedc','#7bd88a','#8e7dff']; for(let i=0;i<100;i++){const p=document.createElement('div');p.className='piece';p.style.left=Math.random()*100+'%';p.style.background=colors[i%colors.length];p.style.transform=`rotate(${Math.random()*360}deg)`;p.style.animationDelay=(Math.random()*0.6)+'s';confetti.appendChild(p);} }

  const rmsFromData=a=>{let s=0;for(let i=0;i<a.length;i++){const v=(a[i]-128)/128;s+=v*v;}return Math.sqrt(s/a.length)};
  let blowOnSince=0;
  function extinguishSome(n){
    if (isComplete || candlesOn.every(v=>!v)) return;
    const left=[];
    for(let i=0;i<N;i++) if(candlesOn[i]) left.push(i);
    for(let k=0;k<n && left.length;k++){
      const j=Math.floor(Math.random()*left.length);
      const idx=left.splice(j,1)[0];
      setCandleState(idx,false);
    }
    if(candlesOn.every(v=>!v)) finish();
  }

  function loop(){
    if(!analyser) return;
    analyser.getByteTimeDomainData(data);
    const rms = rmsFromData(data);
    const now = performance.now();
    if(!isComplete){
      if(rms > THRESHOLD){
        if(!blowOnSince) blowOnSince = now;
        const dur = now - blowOnSince;
        if(dur > 220){
          const n = 1 + Math.min(6, Math.round((rms - THRESHOLD)*40 + dur/350));
          extinguishSome(n);
          blowOnSince = 0;
        }
      } else {
        blowOnSince = 0;
      }
    } else {
      blowOnSince = 0;
    }
    raf = requestAnimationFrame(loop);
  }

  async function startMic(){
    if(location.protocol!=='https:' && location.hostname!=='localhost'){
      alert('Bitte Ã¼ber HTTPS (oder localhost) Ã¶ffnen, sonst verweigert der Browser das Mikro.');
      return;
    }
    try{
      audioStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
      ctx = new (window.AudioContext||window.webkitAudioContext)();
      if(ctx.state==='suspended'){ try{ await ctx.resume(); }catch{} }
      const src = ctx.createMediaStreamSource(audioStream);
      analyser = ctx.createAnalyser();
      analyser.fftSize=2048; analyser.smoothingTimeConstant=0.85; data=new Uint8Array(analyser.fftSize);
      src.connect(analyser);
      cancelAnimationFrame(raf); raf=requestAnimationFrame(loop);
    }catch(err){
      console.error(err);
      alert('Ich brauche dein Mikro, damit du pusten kannst. Bitte erlauben und danach neu laden.');
    }
  }

  // Mikro per lustigem Button starten
  micBtn.addEventListener('click', async () => {
    await startMic();
    micBtn.textContent = 'ğŸ¤ Mikro an â€“ pusten! âœ“';
    micBtn.classList.add('on');
  });
})();
</script>
</body>
</html>
